<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ€ æƒ°ã®ãŸã‚ã®å®¶è¨ˆç°¿</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', 'Yu Gothic', 'Meiryo', sans-serif;
            background: linear-gradient(135deg, #ffeef8 0%, #f0e6ff 50%, #e6f3ff 100%);
            min-height: 100vh;
            padding: 20px;
            position: relative;
            overflow-x: hidden;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(circle at 20% 50%, rgba(255, 182, 193, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(221, 160, 221, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 20%, rgba(176, 224, 230, 0.1) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        h1 {
            text-align: center;
            background: linear-gradient(135deg, #ff6b9d 0%, #c44569 50%, #a55eea 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 30px;
            font-size: 2.8rem;
            font-weight: 800;
            text-shadow: 0 4px 20px rgba(255, 107, 157, 0.3);
            letter-spacing: -0.5px;
        }

        .tabs {
            display: flex;
            gap: 12px;
            margin-bottom: 25px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            padding: 12px;
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(255, 107, 157, 0.15);
            border: 2px solid rgba(255, 255, 255, 0.5);
        }

        .tab-button {
            flex: 1;
            padding: 16px 24px;
            border: none;
            border-radius: 16px;
            font-size: 1.05rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: linear-gradient(135deg, #ffeef8 0%, #f0e6ff 100%);
            color: #c44569;
        }

        .tab-button.active {
            background: linear-gradient(135deg, #ff6b9d 0%, #c44569 100%);
            color: white;
            box-shadow: 0 8px 20px rgba(255, 107, 157, 0.3);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .voice-input-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 24px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(255, 107, 157, 0.15);
            border: 2px solid rgba(255, 255, 255, 0.5);
        }

        .input-step {
            margin-bottom: 25px;
        }

        .input-step-label {
            font-size: 1.1rem;
            font-weight: 700;
            color: #c44569;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .input-step-label.active {
            color: #ff6b9d;
        }

        .input-step-label.active::before {
            content: 'ğŸ¤';
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        .voice-button {
            width: 100%;
            padding: 20px;
            border: none;
            border-radius: 20px;
            font-size: 1.2rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            background: linear-gradient(135deg, #ff6b9d 0%, #c44569 100%);
            color: white;
            box-shadow: 0 8px 20px rgba(255, 107, 157, 0.3);
            margin-bottom: 15px;
        }

        .voice-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 24px rgba(255, 107, 157, 0.4);
        }

        .voice-button:active {
            transform: translateY(0);
        }

        .voice-button.recording {
            background: linear-gradient(135deg, #ff4757 0%, #c44569 100%);
            animation: recording 1.5s infinite;
        }

        @keyframes recording {
            0%, 100% { box-shadow: 0 8px 20px rgba(255, 71, 87, 0.3); }
            50% { box-shadow: 0 8px 30px rgba(255, 71, 87, 0.6); }
        }

        .input-display {
            background: linear-gradient(135deg, #fff0f8 0%, #f5ebff 100%);
            border-radius: 16px;
            padding: 15px;
            margin-top: 10px;
            min-height: 50px;
            font-size: 1.1rem;
            color: #c44569;
            border: 2px solid rgba(255, 107, 157, 0.2);
            display: flex;
            align-items: center;
            cursor: text;
        }

        .input-display.empty {
            color: #d1d5db;
            font-style: italic;
        }

        .input-edit {
            width: 100%;
            background: transparent;
            border: none;
            outline: none;
            font-size: 1.1rem;
            color: #c44569;
            font-family: inherit;
        }

        .input-edit::placeholder {
            color: #d1d5db;
            font-style: italic;
        }

        .edit-button {
            background: rgba(255, 107, 157, 0.1);
            color: #c44569;
            border: none;
            border-radius: 8px;
            padding: 6px 12px;
            font-size: 0.85rem;
            font-weight: 700;
            cursor: pointer;
            margin-left: 10px;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .edit-button:hover {
            background: rgba(255, 107, 157, 0.2);
        }

        .submit-button {
            width: 100%;
            padding: 20px;
            border: none;
            border-radius: 20px;
            font-size: 1.3rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            background: linear-gradient(135deg, #a8e6cf 0%, #88d8a3 100%);
            color: white;
            box-shadow: 0 8px 20px rgba(168, 230, 207, 0.3);
            margin-top: 20px;
        }

        .submit-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 12px 24px rgba(168, 230, 207, 0.4);
        }

        .submit-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .receipt-list {
            display: grid;
            gap: 20px;
        }

        .receipt-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(255, 107, 157, 0.15);
            border: 2px solid rgba(255, 255, 255, 0.5);
            position: relative;
        }

        .delete-button {
            position: absolute;
            top: 15px;
            right: 15px;
            background: #fee2e2;
            color: #dc2626;
            border: none;
            border-radius: 12px;
            padding: 8px 12px;
            font-size: 0.9rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            z-index: 10;
        }

        .delete-button:hover {
            background: #fecaca;
            transform: scale(1.05);
        }

        .receipt-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-right: 80px; /* å‰Šé™¤ãƒœã‚¿ãƒ³ã®ã‚¹ãƒšãƒ¼ã‚¹ã‚’ç¢ºä¿ */
        }

        .receipt-store {
            font-size: 1.3rem;
            font-weight: 700;
            color: #c44569;
        }

        .receipt-amount {
            font-size: 1.8rem;
            font-weight: 800;
            color: #ff6b9d;
        }

        .receipt-info {
            display: flex;
            gap: 20px;
            color: #6b7280;
            font-size: 0.95rem;
            margin-top: 10px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #ff6b9d;
        }

        .empty-state-icon {
            font-size: 5rem;
            margin-bottom: 20px;
            filter: drop-shadow(0 4px 8px rgba(255, 107, 157, 0.3));
            animation: bounce 2s infinite;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .error-message {
            background: #fee2e2;
            color: #dc2626;
            padding: 15px;
            border-radius: 12px;
            margin-top: 10px;
            font-size: 0.95rem;
        }

        .status-message {
            text-align: center;
            padding: 10px;
            margin-top: 10px;
            font-size: 0.95rem;
            color: #6b7280;
        }

        .filter-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(255, 107, 157, 0.15);
            border: 2px solid rgba(255, 255, 255, 0.5);
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-label {
            font-size: 1.1rem;
            font-weight: 700;
            color: #c44569;
        }

        .filter-select {
            flex: 1;
            min-width: 150px;
            padding: 12px 16px;
            border: 2px solid rgba(255, 107, 157, 0.2);
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            color: #c44569;
            background: linear-gradient(135deg, #fff0f8 0%, #f5ebff 100%);
            cursor: pointer;
            transition: all 0.3s;
        }

        .filter-select:hover {
            border-color: rgba(255, 107, 157, 0.4);
        }

        .filter-select:focus {
            outline: none;
            border-color: #ff6b9d;
            box-shadow: 0 0 0 3px rgba(255, 107, 157, 0.1);
        }

        .summary-info {
            margin-left: auto;
            font-size: 1rem;
            color: #6b7280;
            font-weight: 600;
        }

        .summary-amount {
            color: #ff6b9d;
            font-size: 1.2rem;
            font-weight: 800;
        }

    </style>
</head>
<body>
    <div class="container">
        <h1>æ€ æƒ°ã®ãŸã‚ã®å®¶è¨ˆç°¿</h1>

        <div class="tabs">
            <button class="tab-button active" onclick="switchTab('input')">éŸ³å£°å…¥åŠ›</button>
            <button class="tab-button" onclick="switchTab('book')">å®¶è¨ˆç°¿ (<span id="receipt-count">0</span>)</button>
        </div>

        <!-- éŸ³å£°å…¥åŠ›ã‚¿ãƒ– -->
        <div id="input-tab" class="tab-content active">
            <div class="voice-input-card">
                <div class="input-step">
                    <div class="input-step-label" id="voice-label">
                        ğŸ¤ éŸ³å£°å…¥åŠ›
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="voice-button" id="voice-button" onclick="startRecording()">
                            ğŸ¤ éŸ³å£°å…¥åŠ›é–‹å§‹
                        </button>
                        <button class="voice-button" id="stop-button" onclick="stopRecording()" style="display: none; background: linear-gradient(135deg, #ff4757 0%, #c44569 100%);">
                            â¹ï¸ åœæ­¢
                        </button>
                    </div>
                    <div style="font-size: 0.9rem; color: #6b7280; margin-top: 8px; text-align: center;">
                        ä¾‹: ã€Œ2024å¹´1æœˆ1æ—¥ã€ã‚»ãƒ–ãƒ³ã‚¤ãƒ¬ãƒ–ãƒ³ã€1000å††ã€<br>
                        ã¾ãŸã¯ã€Œä»Šæ—¥ã€ã‚³ãƒ³ãƒ“ãƒ‹ã€äºŒåƒä¸‰ç™¾å††ã€
                    </div>
                </div>

                <div class="input-step">
                    <div class="input-step-label">
                        ğŸ“… æ—¥ä»˜
                    </div>
                    <div class="input-display empty" id="date-display" onclick="enableEdit('date')">
                        <input type="date" class="input-edit" id="date-calendar" 
                               onchange="updateInputDataFromDatePicker()" style="display: none;">
                        <span id="date-text">æœªå…¥åŠ›</span>
                        <button class="edit-button" onclick="enableEdit('date'); event.stopPropagation();">âœï¸ ç·¨é›†</button>
                    </div>
                </div>

                <div class="input-step">
                    <div class="input-step-label">
                        ğŸª åº—èˆ—å
                    </div>
                    <div class="input-display empty" id="store-display" onclick="enableEdit('store')">
                        <input type="text" class="input-edit" id="store-input" placeholder="ä¾‹: ã‚»ãƒ–ãƒ³ã‚¤ãƒ¬ãƒ–ãƒ³ã€ã‚³ãƒ³ãƒ“ãƒ‹" 
                               onblur="updateInputData('store')" onkeypress="if(event.key==='Enter') updateInputData('store')" style="display: none;">
                        <span id="store-text">æœªå…¥åŠ›</span>
                        <button class="edit-button" onclick="enableEdit('store'); event.stopPropagation();">âœï¸ ç·¨é›†</button>
                    </div>
                </div>

                <div class="input-step">
                    <div class="input-step-label">
                        ğŸ’° åˆè¨ˆé‡‘é¡
                    </div>
                    <div class="input-display empty" id="amount-display" onclick="enableEdit('amount')">
                        <input type="text" class="input-edit" id="amount-input" placeholder="ä¾‹: 1000å††ã€äºŒåƒä¸‰ç™¾å††" 
                               onblur="updateInputData('amount')" onkeypress="if(event.key==='Enter') updateInputData('amount')" style="display: none;">
                        <span id="amount-text">æœªå…¥åŠ›</span>
                        <button class="edit-button" onclick="enableEdit('amount'); event.stopPropagation();">âœï¸ ç·¨é›†</button>
                    </div>
                </div>

                <button class="submit-button" id="submit-button" onclick="submitReceipt()" disabled>
                    âœ¨ å®¶è¨ˆç°¿ã«è¿½åŠ 
                </button>

                <div id="status-message" class="status-message"></div>
            </div>
        </div>

        <!-- å®¶è¨ˆç°¿ã‚¿ãƒ– -->
        <div id="book-tab" class="tab-content">
            <div class="filter-section">
                <div class="filter-label">ğŸ“… å¹´æœˆã§çµã‚Šè¾¼ã¿:</div>
                <select class="filter-select" id="year-select" onchange="updateFilter()">
                    <option value="all">ã™ã¹ã¦ã®å¹´</option>
                </select>
                <select class="filter-select" id="month-select" onchange="updateFilter()">
                    <option value="all">ã™ã¹ã¦ã®æœˆ</option>
                    <option value="1">1æœˆ</option>
                    <option value="2">2æœˆ</option>
                    <option value="3">3æœˆ</option>
                    <option value="4">4æœˆ</option>
                    <option value="5">5æœˆ</option>
                    <option value="6">6æœˆ</option>
                    <option value="7">7æœˆ</option>
                    <option value="8">8æœˆ</option>
                    <option value="9">9æœˆ</option>
                    <option value="10">10æœˆ</option>
                    <option value="11">11æœˆ</option>
                    <option value="12">12æœˆ</option>
                </select>
                <div class="summary-info" id="summary-info">
                    <span id="summary-text"></span>
                </div>
            </div>
            <div id="receipt-list" class="receipt-list">
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸ“</div>
                    <div style="font-size: 1.2rem; font-weight: 700; margin-bottom: 10px;">ã¾ã å®¶è¨ˆç°¿ã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>
                    <div>éŸ³å£°å…¥åŠ›ã‚¿ãƒ–ã§ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ ã—ã¦ãã ã•ã„</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let receipts = [];
        let recognition = null;
        let inputData = {
            date: '',
            store: '',
            amount: ''
        };

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚
        window.addEventListener('DOMContentLoaded', () => {
            // Web Speech APIã®ã‚µãƒãƒ¼ãƒˆç¢ºèª
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                alert('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°èªè­˜ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚\nChromeã€Edgeã€Safariï¼ˆæœ€æ–°ç‰ˆï¼‰ã‚’ã”ä½¿ç”¨ãã ã•ã„ã€‚');
                return;
            }

            // SpeechRecognitionã®åˆæœŸåŒ–
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.lang = 'ja-JP';
            recognition.continuous = true; // ç¶™ç¶šçš„ã«éŸ³å£°èªè­˜ã‚’è¡Œã†ï¼ˆè‡ªå‹•åœæ­¢ã—ãªã„ï¼‰
            recognition.interimResults = false;

            recognition.onresult = (event) => {
                // æœ€æ–°ã®æœ€çµ‚çµæœã‚’å–å¾—
                for (let i = event.results.length - 1; i >= 0; i--) {
                    if (event.results[i].isFinal) {
                        const transcript = event.results[i][0].transcript;
                        handleVoiceInput(transcript);
                        break;
                    }
                }
            };

            recognition.onerror = (event) => {
                console.error('éŸ³å£°èªè­˜ã‚¨ãƒ©ãƒ¼:', event.error);
                stopRecording();
                showStatus('éŸ³å£°èªè­˜ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚', 'error');
            };

            recognition.onend = () => {
                // éŒ²éŸ³ä¸­ã®å ´åˆã€è‡ªå‹•çš„ã«å†é–‹ï¼ˆç¶™ç¶šèªè­˜ã®ãŸã‚ï¼‰
                const stopButton = document.getElementById('stop-button');
                if (stopButton && stopButton.style.display !== 'none') {
                    // ã¾ã éŒ²éŸ³ä¸­ã®å ´åˆã€è‡ªå‹•çš„ã«å†é–‹
                    try {
                        recognition.start();
                    } catch (e) {
                        // æ—¢ã«é–‹å§‹ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ç„¡è¦–
                        console.log('éŸ³å£°èªè­˜ã®å†é–‹:', e);
                    }
                } else {
                    // åœæ­¢ãƒœã‚¿ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ãªã„å ´åˆã¯ã€ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
                    const startButton = document.getElementById('voice-button');
                    const label = document.getElementById('voice-label');
                    
                    if (startButton) {
                        startButton.classList.remove('recording');
                        startButton.textContent = 'ğŸ¤ éŸ³å£°å…¥åŠ›é–‹å§‹';
                        startButton.style.display = 'block';
                        label.classList.remove('active');
                    }
                }
            };

            loadReceipts();
            updateReceiptList();
            updateSubmitButton();
        });

        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        function switchTab(tab) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
            
            if (tab === 'input') {
                document.getElementById('input-tab').classList.add('active');
                document.querySelectorAll('.tab-button')[0].classList.add('active');
            } else {
                document.getElementById('book-tab').classList.add('active');
                document.querySelectorAll('.tab-button')[1].classList.add('active');
                // å®¶è¨ˆç°¿ã‚¿ãƒ–ã«åˆ‡ã‚Šæ›¿ãˆãŸã¨ãã«åˆè¨ˆé‡‘é¡ã‚’æ›´æ–°
                updateReceiptList();
            }
        }

        // éŸ³å£°èªè­˜é–‹å§‹
        function startRecording() {
            if (!recognition) {
                alert('éŸ³å£°èªè­˜ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“');
                return;
            }

            const startButton = document.getElementById('voice-button');
            const stopButton = document.getElementById('stop-button');
            const label = document.getElementById('voice-label');

            startButton.classList.add('recording');
            startButton.textContent = 'ğŸ¤ éŒ²éŸ³ä¸­...';
            startButton.style.display = 'none';
            stopButton.style.display = 'block';
            label.classList.add('active');

            recognition.start();
        }

        // éŸ³å£°èªè­˜åœæ­¢
        function stopRecording() {
            if (recognition) {
                try {
                    recognition.stop();
                } catch (e) {
                    console.log('éŸ³å£°èªè­˜ã¯æ—¢ã«åœæ­¢ã—ã¦ã„ã¾ã™');
                }
            }

            const startButton = document.getElementById('voice-button');
            const stopButton = document.getElementById('stop-button');
            const label = document.getElementById('voice-label');

            startButton.classList.remove('recording');
            startButton.textContent = 'ğŸ¤ éŸ³å£°å…¥åŠ›é–‹å§‹';
            startButton.style.display = 'block';
            stopButton.style.display = 'none';
            label.classList.remove('active');
        }

        // éŸ³å£°å…¥åŠ›ã®å‡¦ç†ï¼ˆ1å›ã§å…¨ã¦ã‚’æŠ½å‡ºï¼‰
        function handleVoiceInput(transcript) {
            console.log('éŸ³å£°èªè­˜çµæœ:', transcript);
            
            try {
                // æ—¥ä»˜ã€åº—èˆ—åã€é‡‘é¡ã‚’æŠ½å‡º
                const extracted = extractAllInfo(transcript);
                
                console.log('æŠ½å‡ºã•ã‚ŒãŸæƒ…å ±:', extracted);
                
                // æ—¥ä»˜ã®è¨­å®šï¼ˆæ—¥ä»˜ã®ã¿ã‚’å—ã‘ä»˜ã‘ã‚‹ï¼‰
                if (extracted.date) {
                    const validatedDate = validateAndFormatDate(extracted.date);
                    if (validatedDate) {
                        inputData.date = validatedDate;
                        updateDisplay('date', validatedDate);
                    } else {
                        console.warn('æ—¥ä»˜ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“:', extracted.date);
                    }
                } else {
                    console.warn('æ—¥ä»˜ãŒæŠ½å‡ºã§ãã¾ã›ã‚“ã§ã—ãŸ');
                }
                
                // åº—èˆ—åã®è¨­å®šï¼ˆæ—¥ä»˜ã§ã¯ãªã„ã“ã¨ã‚’å³å¯†ã«ç¢ºèªï¼‰
                if (extracted.store) {
                    // åº—èˆ—åãŒæ—¥ä»˜ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã§ãªã„ã“ã¨ã‚’ç¢ºèª
                    const isDatePattern = isDateText(extracted.store);
                    if (!isDatePattern) {
                        inputData.store = extracted.store;
                        updateDisplay('store', extracted.store);
                    } else {
                        console.warn('åº—èˆ—åãŒæ—¥ä»˜ãƒ‘ã‚¿ãƒ¼ãƒ³ã¨åˆ¤å®šã•ã‚Œã¾ã—ãŸã€‚æ—¥ä»˜ã¨ã—ã¦å‡¦ç†ã—ã¾ã™:', extracted.store);
                        // æ—¥ä»˜ã¨ã—ã¦å‡¦ç†ã—ç›´ã™ï¼ˆæ—¥ä»˜ãŒã¾ã è¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆã®ã¿ï¼‰
                        if (!inputData.date) {
                            const validatedDate = validateAndFormatDate(extracted.store);
                            if (validatedDate) {
                                inputData.date = validatedDate;
                                updateDisplay('date', validatedDate);
                            }
                        }
                    }
                } else {
                    console.warn('åº—èˆ—åãŒæŠ½å‡ºã§ãã¾ã›ã‚“ã§ã—ãŸ');
                }
                
                // é‡‘é¡ã®è¨­å®š
                if (extracted.amount) {
                    inputData.amount = extracted.amount;
                    updateDisplay('amount', extracted.amount);
                } else {
                    console.warn('é‡‘é¡ãŒæŠ½å‡ºã§ãã¾ã›ã‚“ã§ã—ãŸ');
                }
                
                updateSubmitButton();
                
                if (extracted.date || extracted.store || extracted.amount) {
                    showStatus('å…¥åŠ›ã‚’å—ã‘ä»˜ã‘ã¾ã—ãŸ', 'success');
                } else {
                    showStatus('æƒ…å ±ã‚’æŠ½å‡ºã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚', 'error');
                }
            } catch (error) {
                console.error('éŸ³å£°å…¥åŠ›å‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
                showStatus('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚', 'error');
            }
        }

        // å…¨ã¦ã®æƒ…å ±ã‚’æŠ½å‡º
        function extractAllInfo(text) {
            const result = {
                date: '',
                store: '',
                amount: ''
            };

            // åŒºåˆ‡ã‚Šæ–‡å­—ï¼ˆã€ã‚„ã€ï¼‰ã§åˆ†å‰²
            const parts = text.split(/[ã€,ã€‚.ï¼Œ]/).map(p => p.trim()).filter(p => p.length > 0);
            
            console.log('åˆ†å‰²ã•ã‚ŒãŸéƒ¨åˆ†:', parts);

            // å„éƒ¨åˆ†ã‚’é †ç•ªã«è§£æ
            for (const part of parts) {
                if (!part || part.trim().length === 0) continue;
                
                let partProcessed = false;
                
                // æ—¥ä»˜ã®ãƒã‚§ãƒƒã‚¯ï¼ˆã¾ã æ—¥ä»˜ãŒæŠ½å‡ºã•ã‚Œã¦ã„ãªã„å ´åˆã®ã¿ï¼‰
                if (!result.date) {
                    const date = extractDate(part);
                    if (date) {
                        result.date = date;
                        partProcessed = true;
                        console.log('æ—¥ä»˜ã‚’æŠ½å‡º:', date, 'from:', part);
                    }
                }
                
                // é‡‘é¡ã®ãƒã‚§ãƒƒã‚¯ï¼ˆã¾ã é‡‘é¡ãŒæŠ½å‡ºã•ã‚Œã¦ã„ãªã„å ´åˆã®ã¿ã€ã‹ã¤æ—¥ä»˜ã§ãªã„å ´åˆï¼‰
                if (!result.amount && !partProcessed) {
                    const amount = extractAmount(part);
                    if (amount) {
                        result.amount = amount;
                        partProcessed = true;
                        console.log('é‡‘é¡ã‚’æŠ½å‡º:', amount, 'from:', part);
                    }
                }
                
                // æ—¥ä»˜ã§ã‚‚é‡‘é¡ã§ã‚‚ãªã„å ´åˆã€åº—èˆ—åã¨ã—ã¦æ‰±ã†
                if (!partProcessed) {
                    // æ—¥ä»˜ã‚„é‡‘é¡ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒå«ã¾ã‚Œã¦ã„ãªã„ã“ã¨ã‚’ç¢ºèª
                    const hasDatePattern = /(\d{1,4})å¹´?(\d{1,2})æœˆ(\d{1,2})æ—¥|ä»Šæ—¥|æ˜¨æ—¥|ä¸€æ˜¨æ—¥|æœ¬æ—¥/.test(part);
                    const hasAmountPattern = /[\d,]+å††|[\u4e00-\u9fa5]+å††/.test(part);
                    
                    if (!hasDatePattern && !hasAmountPattern && part.length > 0) {
                        // åº—èˆ—åãŒã¾ã è¨­å®šã•ã‚Œã¦ã„ãªã„ã€ã¾ãŸã¯ç¾åœ¨ã®éƒ¨åˆ†ãŒã‚ˆã‚Šé•·ã„å ´åˆ
                        if (!result.store || part.length > result.store.length) {
                            result.store = part;
                            console.log('åº—èˆ—åã‚’æŠ½å‡º:', part);
                        }
                    } else {
                        console.log('åº—èˆ—åå€™è£œã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼ˆæ—¥ä»˜/é‡‘é¡ãƒ‘ã‚¿ãƒ¼ãƒ³å«ã‚€ï¼‰:', part);
                    }
                }
            }

            // åŒºåˆ‡ã‚Šæ–‡å­—ãŒãªã„å ´åˆã€å…¨ä½“ã‹ã‚‰æŠ½å‡ºã‚’è©¦ã¿ã‚‹
            if (!result.date || !result.store || !result.amount) {
                // æ—¥ä»˜ã®æŠ½å‡º
                if (!result.date) {
                    result.date = extractDate(text);
                }
                
                // é‡‘é¡ã®æŠ½å‡º
                if (!result.amount) {
                    result.amount = extractAmount(text);
                }
                
                // åº—èˆ—åã®æŠ½å‡ºï¼ˆæ—¥ä»˜ã¨é‡‘é¡ä»¥å¤–ã®éƒ¨åˆ†ï¼‰
                if (!result.store) {
                    result.store = extractStoreName(text, result.date, result.amount);
                }
            }

            console.log('æŠ½å‡ºçµæœ:', result);
            return result;
        }

        // æ—¥ä»˜ã®æŠ½å‡º
        function extractDate(text) {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            
            // ã€Œä»Šæ—¥ã€ã€Œæœ¬æ—¥ã€
            if (text.includes('ä»Šæ—¥') || text.includes('æœ¬æ—¥')) {
                return formatDate(today);
            }
            
            // ã€Œæ˜¨æ—¥ã€
            if (text.includes('æ˜¨æ—¥')) {
                const yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);
                return formatDate(yesterday);
            }
            
            // ã€Œä¸€æ˜¨æ—¥ã€
            if (text.includes('ä¸€æ˜¨æ—¥')) {
                const dayBefore = new Date(today);
                dayBefore.setDate(dayBefore.getDate() - 2);
                return formatDate(dayBefore);
            }

            // æ—¥ä»˜ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆ2024å¹´1æœˆ1æ—¥ã€1æœˆ1æ—¥ãªã©ï¼‰
            const datePatterns = [
                /(\d{4})å¹´(\d{1,2})æœˆ(\d{1,2})æ—¥/,
                /(\d{1,2})æœˆ(\d{1,2})æ—¥/
            ];

            for (const pattern of datePatterns) {
                const match = text.match(pattern);
                if (match) {
                    if (match[1] && match[1].length === 4) {
                        // å¹´ãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆ
                        const year = parseInt(match[1]);
                        const month = parseInt(match[2]);
                        const day = parseInt(match[3]);
                        return formatDate(new Date(year, month - 1, day));
                    } else {
                        // å¹´ãŒå«ã¾ã‚Œã¦ã„ãªã„å ´åˆï¼ˆä»Šå¹´ã¨ä»®å®šï¼‰
                        const month = parseInt(match[1]);
                        const day = parseInt(match[2]);
                        return formatDate(new Date(now.getFullYear(), month - 1, day));
                    }
                }
            }

            return '';
        }

        // é‡‘é¡ã®æŠ½å‡º
        function extractAmount(text) {
            // æ•°å­—ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æŠ½å‡º
            const numberPatterns = [
                /([\d,]+)å††/,
                /([\d,]+)/
            ];

            for (const pattern of numberPatterns) {
                const match = text.match(pattern);
                if (match) {
                    const amount = parseInt(match[1].replace(/,/g, ''), 10);
                    if (amount > 0 && amount <= 1000000) {
                        return `${amount}å††`;
                    }
                }
            }

            // æ¼¢æ•°å­—ã®å‡¦ç†ï¼ˆç°¡æ˜“ç‰ˆï¼‰
            const kanjiPattern = /([ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹åç™¾åƒä¸‡]+)å††/;
            const kanjiMatch = text.match(kanjiPattern);
            if (kanjiMatch) {
                const kanjiAmount = convertKanjiToNumber(kanjiMatch[1]);
                if (kanjiAmount > 0) {
                    return `${kanjiAmount}å††`;
                }
            }

            return '';
        }

        // æ¼¢æ•°å­—ã‚’æ•°å­—ã«å¤‰æ›ï¼ˆç°¡æ˜“ç‰ˆï¼‰
        function convertKanjiToNumber(kanji) {
            const kanjiMap = {
                'ä¸€': 1, 'äºŒ': 2, 'ä¸‰': 3, 'å››': 4, 'äº”': 5,
                'å…­': 6, 'ä¸ƒ': 7, 'å…«': 8, 'ä¹': 9, 'å': 10
            };

            let result = 0;
            
            if (kanji.includes('åƒ')) {
                const parts = kanji.split('åƒ');
                if (parts[0]) {
                    result += (kanjiMap[parts[0]] || parseInt(parts[0]) || 1) * 1000;
                } else {
                    result += 1000;
                }
                kanji = parts[1] || '';
            }
            
            if (kanji.includes('ç™¾')) {
                const parts = kanji.split('ç™¾');
                if (parts[0]) {
                    result += (kanjiMap[parts[0]] || parseInt(parts[0]) || 1) * 100;
                } else {
                    result += 100;
                }
                kanji = parts[1] || '';
            }
            
            if (kanji.includes('å')) {
                const parts = kanji.split('å');
                if (parts[0]) {
                    result += (kanjiMap[parts[0]] || parseInt(parts[0]) || 1) * 10;
                } else {
                    result += 10;
                }
                kanji = parts[1] || '';
            }
            
            if (kanji && kanjiMap[kanji]) {
                result += kanjiMap[kanji];
            }

            return result;
        }

        // åº—èˆ—åã®æŠ½å‡º
        function extractStoreName(text, date, amount) {
            if (!text || typeof text !== 'string') {
                return '';
            }
            
            // æ—¥ä»˜ã¨é‡‘é¡ã®éƒ¨åˆ†ã‚’å‰Šé™¤
            let storeText = text;
            
            if (date) {
                // æ—¥ä»˜ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å‰Šé™¤ï¼ˆã‚ˆã‚ŠåŒ…æ‹¬çš„ã«ï¼‰
                storeText = storeText.replace(/(\d{4})å¹´(\d{1,2})æœˆ(\d{1,2})æ—¥/g, '');
                storeText = storeText.replace(/(\d{1,2})æœˆ(\d{1,2})æ—¥/g, '');
                storeText = storeText.replace(/(\d{4})\/(\d{1,2})\/(\d{1,2})/g, '');
                storeText = storeText.replace(/(\d{1,2})\/(\d{1,2})/g, '');
                storeText = storeText.replace(/ä»Šæ—¥|æœ¬æ—¥|æ˜¨æ—¥|ä¸€æ˜¨æ—¥/g, '');
            }
            
            if (amount) {
                // é‡‘é¡ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å‰Šé™¤
                storeText = storeText.replace(/([\d,]+|[\u4e00-\u9fa5]+)å††/g, '');
            }
            
            // åŒºåˆ‡ã‚Šæ–‡å­—ã‚’å‰Šé™¤
            storeText = storeText.replace(/[ã€,ã€‚.ï¼Œ]/g, ' ').trim();
            
            // ç©ºç™½ã§åˆ†å‰²ã—ã¦ã€æœ€ã‚‚é•·ã„æ–‡å­—åˆ—ã‚’åº—èˆ—åã¨ã™ã‚‹
            const words = storeText.split(/\s+/).filter(w => w.length > 0);
            if (words.length > 0) {
                // æœ€ã‚‚é•·ã„å˜èªã‚’åº—èˆ—åã¨ã™ã‚‹
                return words.reduce((a, b) => a.length > b.length ? a : b);
            }

            return '';
        }


        // æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}å¹´${month}æœˆ${day}æ—¥`;
        }


        // è¡¨ç¤ºæ›´æ–°
        function updateDisplay(type, value) {
            const textSpan = document.getElementById(`${type}-text`);
            const display = document.getElementById(`${type}-display`);
            
            if (type === 'date') {
                // æ—¥ä»˜ã®å ´åˆã¯ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«åæ˜ 
                const calendarInput = document.getElementById('date-calendar');
                if (value && calendarInput) {
                    const dateMatch = value.match(/(\d{4})å¹´(\d{1,2})æœˆ(\d{1,2})æ—¥/);
                    if (dateMatch) {
                        const year = parseInt(dateMatch[1]);
                        const month = parseInt(dateMatch[2]);
                        const day = parseInt(dateMatch[3]);
                        const date = new Date(year, month - 1, day);
                        calendarInput.value = date.toISOString().split('T')[0];
                    }
                }
            } else {
                const inputField = document.getElementById(`${type}-input`);
                if (inputField) {
                    inputField.value = value || '';
                }
            }
            
            if (value) {
                textSpan.textContent = value;
                display.classList.remove('empty');
            } else {
                textSpan.textContent = 'æœªå…¥åŠ›';
                display.classList.add('empty');
            }
        }

        // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã‚’æœ‰åŠ¹åŒ–
        function enableEdit(type) {
            const textSpan = document.getElementById(`${type}-text`);
            
            if (type === 'date') {
                const calendarInput = document.getElementById('date-calendar');
                // æ—¥ä»˜ã®å ´åˆã¯ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®ã¿ã‚’è¡¨ç¤º
                textSpan.style.display = 'none';
                calendarInput.style.display = 'block';
                
                // æ—¢å­˜ã®æ—¥ä»˜ãŒã‚ã‚‹å ´åˆã€ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«è¨­å®š
                if (inputData.date) {
                    const dateMatch = inputData.date.match(/(\d{4})å¹´(\d{1,2})æœˆ(\d{1,2})æ—¥/);
                    if (dateMatch) {
                        const year = parseInt(dateMatch[1]);
                        const month = parseInt(dateMatch[2]);
                        const day = parseInt(dateMatch[3]);
                        const date = new Date(year, month - 1, day);
                        calendarInput.value = date.toISOString().split('T')[0];
                    }
                }
                calendarInput.focus();
            } else {
                const inputField = document.getElementById(`${type}-input`);
                // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¡¨ç¤º
                textSpan.style.display = 'none';
                inputField.style.display = 'block';
                inputField.value = inputData[type] || '';
                inputField.focus();
                inputField.select();
            }
        }

        // æ—¥ä»˜ãƒ”ãƒƒã‚«ãƒ¼ã‹ã‚‰ã®å…¥åŠ›å‡¦ç†
        function updateInputDataFromDatePicker() {
            const calendarInput = document.getElementById('date-calendar');
            const dateValue = calendarInput.value;
            
            if (dateValue) {
                // YYYY-MM-DDå½¢å¼ã‹ã‚‰ Date ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰æ›
                const date = new Date(dateValue);
                if (!isNaN(date.getTime())) {
                    const formattedDate = formatDate(date);
                    inputData.date = formattedDate;
                    updateDisplay('date', formattedDate);
                    updateSubmitButton();
                    
                    // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’éè¡¨ç¤º
                    calendarInput.style.display = 'none';
                    const textSpan = document.getElementById('date-text');
                    if (textSpan) textSpan.style.display = 'inline';
                }
            }
        }

        // å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
        function updateInputData(type) {
            const textSpan = document.getElementById(`${type}-text`);
            const inputField = document.getElementById(`${type}-input`);
            
            // æ—¥ä»˜ã®å ´åˆã¯å‡¦ç†ã—ãªã„ï¼ˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‹ã‚‰ã®ã¿å…¥åŠ›ï¼‰
            if (type === 'date') {
                return;
            }
            
            let value = inputField.value.trim();
            
            // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’éè¡¨ç¤º
            inputField.style.display = 'none';
            textSpan.style.display = 'inline';
            
            // å€¤ã®å‡¦ç†
            if (value) {
                if (type === 'store') {
                    // åº—èˆ—åã«æ—¥ä»˜ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒå«ã¾ã‚Œã¦ã„ãªã„ã‹ç¢ºèª
                    if (isDateText(value)) {
                        showStatus('åº—èˆ—åã«ã¯æ—¥ä»˜ã‚’å…¥åŠ›ã§ãã¾ã›ã‚“ã€‚æ—¥ä»˜ã¯æ—¥ä»˜æ¬„ã«å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', 'error');
                        inputField.focus();
                        return;
                    }
                } else if (type === 'amount') {
                    // é‡‘é¡ã®å‡¦ç†ï¼ˆã€Œå††ã€ãŒå«ã¾ã‚Œã¦ã„ãªã„å ´åˆã¯è¿½åŠ ï¼‰
                    if (!value.includes('å††') && !isNaN(parseInt(value.replace(/,/g, '')))) {
                        value = value + 'å††';
                    }
                }
                
                inputData[type] = value;
                updateDisplay(type, value);
                updateSubmitButton();
            } else {
                inputData[type] = '';
                updateDisplay(type, '');
                updateSubmitButton();
            }
        }

        // æ—¥ä»˜ãƒ†ã‚­ã‚¹ãƒˆã‹ã©ã†ã‹ã‚’åˆ¤å®š
        function isDateText(text) {
            if (!text || typeof text !== 'string') return false;
            const datePatterns = [
                /(\d{1,4})å¹´?(\d{1,2})æœˆ(\d{1,2})æ—¥/,
                /ä»Šæ—¥|æ˜¨æ—¥|ä¸€æ˜¨æ—¥|æœ¬æ—¥/,
                /(\d{4})\/(\d{1,2})\/(\d{1,2})/,
                /(\d{1,2})\/(\d{1,2})/
            ];
            return datePatterns.some(pattern => pattern.test(text));
        }

        // æ—¥ä»˜ã‚’æ¤œè¨¼ã—ã¦ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        function validateAndFormatDate(text) {
            if (!text || typeof text !== 'string') return '';
            
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            
            // ã€Œä»Šæ—¥ã€ã€Œæœ¬æ—¥ã€
            if (text.includes('ä»Šæ—¥') || text.includes('æœ¬æ—¥')) {
                return formatDate(today);
            }
            
            // ã€Œæ˜¨æ—¥ã€
            if (text.includes('æ˜¨æ—¥')) {
                const yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);
                return formatDate(yesterday);
            }
            
            // ã€Œä¸€æ˜¨æ—¥ã€
            if (text.includes('ä¸€æ˜¨æ—¥')) {
                const dayBefore = new Date(today);
                dayBefore.setDate(dayBefore.getDate() - 2);
                return formatDate(dayBefore);
            }

            // æ—¥ä»˜ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æŠ½å‡º
            const datePatterns = [
                /(\d{4})å¹´(\d{1,2})æœˆ(\d{1,2})æ—¥/,
                /(\d{1,2})æœˆ(\d{1,2})æ—¥/,
                /(\d{4})\/(\d{1,2})\/(\d{1,2})/,
                /(\d{1,2})\/(\d{1,2})/
            ];

            for (const pattern of datePatterns) {
                const match = text.match(pattern);
                if (match) {
                    let year, month, day;
                    
                    if (match.length === 4 && match[1].length === 4) {
                        // YYYYå¹´MMæœˆDDæ—¥ ã¾ãŸã¯ YYYY/MM/DD
                        year = parseInt(match[1], 10);
                        month = parseInt(match[2], 10);
                        day = parseInt(match[3], 10);
                    } else if (match.length === 3) {
                        // MMæœˆDDæ—¥ ã¾ãŸã¯ MM/DD
                        year = now.getFullYear();
                        month = parseInt(match[1], 10);
                        day = parseInt(match[2], 10);
                    }
                    
                    if (year && month && day && month >= 1 && month <= 12 && day >= 1 && day <= 31) {
                        const date = new Date(year, month - 1, day);
                        if (!isNaN(date.getTime())) {
                            return formatDate(date);
                        }
                    }
                }
            }

            return '';
        }

        // æ—¥ä»˜å…¥åŠ›ã®å‡¦ç†
        function processDateInput(text) {
            return validateAndFormatDate(text);
        }

        // é€ä¿¡ãƒœã‚¿ãƒ³ã®æ›´æ–°
        function updateSubmitButton() {
            const button = document.getElementById('submit-button');
            const hasAllData = inputData.date && inputData.store && inputData.amount;
            button.disabled = !hasAllData;
        }

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status-message');
            statusDiv.textContent = message;
            statusDiv.className = type === 'error' ? 'error-message' : 'status-message';
            statusDiv.style.display = 'block';

            if (type !== 'error') {
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 3000);
            }
        }

        // å®¶è¨ˆç°¿ã«è¿½åŠ 
        function submitReceipt() {
            if (!inputData.date || !inputData.store || !inputData.amount) {
                showStatus('ã™ã¹ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }

            // é‡‘é¡ã‚’æ•°å€¤ã«å¤‰æ›
            const amountMatch = inputData.amount.match(/([\d,]+)/);
            const amount = amountMatch ? parseInt(amountMatch[1].replace(/,/g, ''), 10) : 0;

            if (amount <= 0) {
                showStatus('æ­£ã—ã„é‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }

            // æ—¥ä»˜ã‚’ãƒ‘ãƒ¼ã‚¹
            const dateMatch = inputData.date.match(/(\d{4})å¹´(\d{1,2})æœˆ(\d{1,2})æ—¥/);
            if (!dateMatch) {
                showStatus('æ­£ã—ã„æ—¥ä»˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }

            const year = parseInt(dateMatch[1]);
            const month = parseInt(dateMatch[2]);
            const day = parseInt(dateMatch[3]);
            const date = new Date(year, month - 1, day);
            const dateStr = date.toISOString().split('T')[0];

            // ãƒ¬ã‚·ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
            const receipt = {
                id: Date.now().toString(),
                date: dateStr,
                year: year,
                month: month,
                day: day,
                time: new Date().toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' }),
                storeName: inputData.store,
                amount: amount,
                createdAt: new Date().toISOString()
            };

            receipts.push(receipt);
            saveReceipts();
            updateReceiptList();
            
            // å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ
            inputData = { date: '', store: '', amount: '' };
            document.getElementById('date-display').textContent = 'ä¾‹: 2024å¹´1æœˆ1æ—¥ã€ä»Šæ—¥ã€æ˜¨æ—¥';
            document.getElementById('date-display').classList.add('empty');
            document.getElementById('store-display').textContent = 'ä¾‹: ã‚»ãƒ–ãƒ³ã‚¤ãƒ¬ãƒ–ãƒ³ã€ã‚³ãƒ³ãƒ“ãƒ‹';
            document.getElementById('store-display').classList.add('empty');
            document.getElementById('amount-display').textContent = 'ä¾‹: 1000å††ã€äºŒåƒä¸‰ç™¾å††';
            document.getElementById('amount-display').classList.add('empty');
            updateSubmitButton();

            showStatus('å®¶è¨ˆç°¿ã«è¿½åŠ ã—ã¾ã—ãŸï¼', 'success');
            switchTab('book');
        }

        // ãƒ¬ã‚·ãƒ¼ãƒˆãƒªã‚¹ãƒˆã®æ›´æ–°
        function updateReceiptList() {
            const listDiv = document.getElementById('receipt-list');
            const countSpan = document.getElementById('receipt-count');

            countSpan.textContent = receipts.length;

            // å¹´æœˆã®é¸æŠè‚¢ã‚’æ›´æ–°
            updateYearMonthOptions();

            // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
            const filteredReceipts = getFilteredReceipts();
            
            console.log('å…¨ãƒ¬ã‚·ãƒ¼ãƒˆæ•°:', receipts.length);
            console.log('ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°å¾Œã®ãƒ¬ã‚·ãƒ¼ãƒˆæ•°:', filteredReceipts.length);
            console.log('ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°å¾Œã®ãƒ¬ã‚·ãƒ¼ãƒˆ:', filteredReceipts);

            // æ—¥ä»˜ã§ã‚½ãƒ¼ãƒˆï¼ˆæ–°ã—ã„é †ï¼‰
            const sortedReceipts = [...filteredReceipts].sort((a, b) => {
                return new Date(b.date) - new Date(a.date);
            });

            if (sortedReceipts.length === 0) {
                if (receipts.length === 0) {
                    listDiv.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ“</div>
                            <div style="font-size: 1.2rem; font-weight: 700; margin-bottom: 10px;">ã¾ã å®¶è¨ˆç°¿ã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>
                            <div>éŸ³å£°å…¥åŠ›ã‚¿ãƒ–ã§ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ ã—ã¦ãã ã•ã„</div>
                        </div>
                    `;
                } else {
                    listDiv.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ”</div>
                            <div style="font-size: 1.2rem; font-weight: 700; margin-bottom: 10px;">è©²å½“ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>
                            <div>å¹´æœˆã‚’å¤‰æ›´ã—ã¦æ¤œç´¢ã—ã¦ãã ã•ã„</div>
                        </div>
                    `;
                }
                // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã•ã‚ŒãŸãƒ¬ã‚·ãƒ¼ãƒˆã®åˆè¨ˆï¼ˆ0ä»¶ãªã®ã§0å††ï¼‰
                updateSummary(0, 0);
                return;
            }

            listDiv.innerHTML = sortedReceipts.map(receipt => `
                <div class="receipt-card">
                    <button class="delete-button" onclick="deleteReceipt('${receipt.id}')">ğŸ—‘ï¸ å‰Šé™¤</button>
                    <div class="receipt-header">
                        <div class="receipt-store">${receipt.storeName}</div>
                        <div class="receipt-amount">${receipt.amount.toLocaleString()}å††</div>
                    </div>
                    <div class="receipt-info">
                        <span>ğŸ“… ${receipt.year}å¹´${receipt.month}æœˆ${receipt.day}æ—¥</span>
                        <span>ğŸ• ${receipt.time}</span>
                    </div>
                </div>
            `).join('');

            // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã•ã‚ŒãŸãƒ¬ã‚·ãƒ¼ãƒˆã®åˆè¨ˆé‡‘é¡ã‚’è¨ˆç®—
            const filteredTotalAmount = sortedReceipts.reduce((sum, receipt) => {
                return sum + receipt.amount;
            }, 0);

            // åˆè¨ˆé‡‘é¡ã‚’è¡¨ç¤º
            updateSummary(filteredTotalAmount, sortedReceipts.length);
        }

        // åˆè¨ˆé‡‘é¡ã‚’è¡¨ç¤º
        function updateSummary(totalAmount, count) {
            const summaryInfo = document.getElementById('summary-info');
            const summaryText = document.getElementById('summary-text');
            
            if (!summaryInfo || !summaryText) return;

            const yearSelect = document.getElementById('year-select');
            const monthSelect = document.getElementById('month-select');
            
            if (!yearSelect || !monthSelect) return;

            const selectedYear = yearSelect.value;
            const selectedMonth = monthSelect.value;

            if (selectedYear !== 'all' || selectedMonth !== 'all') {
                let periodText = '';
                if (selectedYear !== 'all' && selectedMonth !== 'all') {
                    periodText = `${selectedYear}å¹´${selectedMonth}æœˆã®`;
                } else if (selectedYear !== 'all') {
                    periodText = `${selectedYear}å¹´ã®`;
                } else if (selectedMonth !== 'all') {
                    periodText = `${selectedMonth}æœˆã®`;
                }
                summaryText.innerHTML = `${periodText}åˆè¨ˆ: <span class="summary-amount">${totalAmount.toLocaleString()}</span>å†† (${count}ä»¶)`;
            } else {
                summaryText.innerHTML = `åˆè¨ˆ: <span class="summary-amount">${totalAmount.toLocaleString()}</span>å†† (${count}ä»¶)`;
            }
        }

        // å¹´æœˆã®é¸æŠè‚¢ã‚’æ›´æ–°
        function updateYearMonthOptions() {
            const yearSelect = document.getElementById('year-select');
            if (!yearSelect) return;
            
            const existingYears = new Set();
            
            receipts.forEach(receipt => {
                existingYears.add(receipt.year);
            });

            // æ—¢å­˜ã®å¹´ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä¿æŒï¼ˆã€Œã™ã¹ã¦ã®å¹´ã€ä»¥å¤–ï¼‰
            const currentYear = yearSelect.value;
            yearSelect.innerHTML = '<option value="all">ã™ã¹ã¦ã®å¹´</option>';
            
            // å¹´ã‚’é™é †ã§ã‚½ãƒ¼ãƒˆ
            const sortedYears = Array.from(existingYears).sort((a, b) => b - a);
            
            sortedYears.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = `${year}å¹´`;
                yearSelect.appendChild(option);
            });

            // ç¾åœ¨ã®é¸æŠã‚’å¾©å…ƒ
            if (currentYear && currentYear !== 'all') {
                yearSelect.value = currentYear;
            }
        }

        // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã•ã‚ŒãŸãƒ¬ã‚·ãƒ¼ãƒˆã‚’å–å¾—
        function getFilteredReceipts() {
            const yearSelect = document.getElementById('year-select');
            const monthSelect = document.getElementById('month-select');
            
            if (!yearSelect || !monthSelect) {
                console.log('ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚å…¨ãƒ¬ã‚·ãƒ¼ãƒˆã‚’è¿”ã—ã¾ã™ã€‚');
                return receipts;
            }
            
            const selectedYear = yearSelect.value;
            const selectedMonth = monthSelect.value;

            console.log('ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°æ¡ä»¶:', { selectedYear, selectedMonth });

            const filtered = receipts.filter(receipt => {
                const matchYear = selectedYear === 'all' || receipt.year.toString() === selectedYear;
                const matchMonth = selectedMonth === 'all' || receipt.month.toString() === selectedMonth;
                const matches = matchYear && matchMonth;
                
                if (!matches) {
                    console.log(`ãƒ¬ã‚·ãƒ¼ãƒˆé™¤å¤–: ${receipt.year}å¹´${receipt.month}æœˆ - å¹´ãƒãƒƒãƒ:${matchYear}, æœˆãƒãƒƒãƒ:${matchMonth}`);
                }
                
                return matches;
            });

            console.log('ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°çµæœ:', filtered.length, 'ä»¶');
            return filtered;
        }

        // ãƒ•ã‚£ãƒ«ã‚¿ã‚’æ›´æ–°
        function updateFilter() {
            updateReceiptList();
        }


        // ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜
        function saveReceipts() {
            localStorage.setItem('receipts', JSON.stringify(receipts));
        }

        // ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
        function loadReceipts() {
            const saved = localStorage.getItem('receipts');
            if (saved) {
                receipts = JSON.parse(saved);
            }
        }

        // ãƒ¬ã‚·ãƒ¼ãƒˆã®å‰Šé™¤
        function deleteReceipt(id) {
            if (confirm('ã“ã®å®¶è¨ˆç°¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                receipts = receipts.filter(r => r.id !== id);
                saveReceipts();
                updateReceiptList();
                showStatus('å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
            }
        }
    </script>
</body>
</html>
